# 设备管理功能修复说明

## 修复的问题

### 1. 字段映射问题
**问题描述**: 前端和后端的字段名称不匹配
- 前端使用 `deviceName` 和 `productName`
- 后端模型使用 `eqName` 和 `productsId`

**修复方案**:
- 修改前端设备管理页面 (`gin-vue-admin-main/web/src/view/system/device/index.vue`)
- 修改前端设备对话框组件 (`gin-vue-admin-main/web/src/view/system/device/components/DeviceDialog.vue`)
- 更新API调用中的字段名称

### 2. 状态字段缺失
**问题描述**: 后端模型中没有status字段，但前端在使用

**修复方案**:
- 在 `gin-vue-admin-main/server/model/wl_playform/wl_equipment.go` 中添加Status字段
- 在 `gin-vue-admin-main/server/model/wl_playform/request/wl_equipment.go` 中添加Status搜索字段
- 在 `gin-vue-admin-main/server/service/wl_playform/wl_equipment.go` 中添加Status搜索逻辑
- 创建数据库迁移脚本 `gin-vue-admin-main/add_status_to_wl_equipment.sql`

### 3. 字段名称不一致
**问题描述**: 前端删除确认对话框中使用错误的字段名

**修复方案**:
- 将删除确认中的 `row.deviceName` 改为 `row.eqName`
- 将编辑时的 `row.id` 改为 `row.ID`
- 将删除API调用中的 `row.id` 改为 `row.ID`

### 4. 时间字段格式问题
**问题描述**: 前端显示时间时使用错误的字段名

**修复方案**:
- 将 `row.createdAt` 改为 `row.CreatedAt`

### 5. 产品ID字段类型问题 ⭐ **新增**
**问题描述**: 后端模型中ProductsId字段使用指针类型，导致JSON绑定和验证问题

**修复方案**:
- 将 `ProductsId *int` 改为 `ProductsId int`
- 更新搜索请求结构中的字段类型
- 更新服务层搜索逻辑
- 修复前端表单验证规则

### 6. PowerShell命令语法问题 ⭐ **新增**
**问题描述**: Windows PowerShell不支持`&&`语法

**修复方案**:
- 分别执行 `cd gin-vue-admin-main/server` 和 `go run main.go`
- 或使用 `;` 分隔符：`cd gin-vue-admin-main/server; go run main.go`

## 修复的文件列表

### 前端文件
1. `gin-vue-admin-main/web/src/view/system/device/index.vue`
   - 修复字段映射
   - 修复删除确认对话框
   - 修复时间字段显示
   - 修复搜索表单产品ID字段类型

2. `gin-vue-admin-main/web/src/view/system/device/components/DeviceDialog.vue`
   - 更新表单字段名称
   - 修复表单验证规则
   - 更新数据加载逻辑
   - 修复产品ID字段验证

3. `gin-vue-admin-main/web/src/api/device.js`
   - 更新API文档注释
   - 确保字段类型正确

### 后端文件
1. `gin-vue-admin-main/server/model/wl_playform/wl_equipment.go`
   - 添加Status字段
   - 修复ProductsId字段类型（指针改为值类型）

2. `gin-vue-admin-main/server/model/wl_playform/request/wl_equipment.go`
   - 添加Status搜索字段
   - 修复ProductsId字段类型

3. `gin-vue-admin-main/server/service/wl_playform/wl_equipment.go`
   - 添加Status搜索逻辑
   - 更新ProductsId搜索逻辑

### 数据库迁移
1. `gin-vue-admin-main/add_status_to_wl_equipment.sql`
   - 为wl_equipment表添加status字段

### 测试文件
1. `gin-vue-admin-main/test_device_api.js`
   - 创建API测试脚本

## 使用说明

### 运行数据库迁移
```sql
-- 执行以下SQL语句为wl_equipment表添加status字段
ALTER TABLE wl_equipment ADD COLUMN status VARCHAR(20) DEFAULT '启用' COMMENT '设备状态';
UPDATE wl_equipment SET status = '启用' WHERE status IS NULL;
```

### 重启服务
1. 重启后端服务以应用模型更改
   ```powershell
   cd gin-vue-admin-main/server
   go run main.go
   ```

2. 重启前端服务以应用前端修复
   ```bash
   cd gin-vue-admin-main/web
   npm run dev
   ```

## 功能验证

修复后的设备管理功能应该支持：
1. 设备列表查询（支持按设备名称、产品ID、状态搜索）
2. 新增设备（设备名称、产品ID、设备描述、状态）
3. 编辑设备
4. 删除设备
5. 分页显示
6. 状态标签显示
7. 产品ID字段正确验证和提交

## 注意事项

1. 确保数据库已执行迁移脚本
2. 确保后端服务已重启以应用模型更改
3. 确保前端服务已重启以应用前端修复
4. 如果仍有问题，请检查浏览器控制台和后端日志
5. 产品ID字段现在使用数字类型，确保输入的是有效数字

## 测试方法

1. 打开浏览器开发者工具
2. 在控制台中运行测试脚本：
   ```javascript
   // 复制 test_device_api.js 中的函数到控制台
   testCreateDevice();
   testGetDeviceList();
   ``` 