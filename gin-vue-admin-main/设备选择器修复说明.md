# 设备选择器修复说明

## 问题描述

在部门管理中点击"新增"后，再点击"选择设备"时，设备列表显示为空。这是因为设备选择器组件使用了错误的API来获取设备数据。

## 修复内容

### 1. 修复设备选择器API调用

**问题**: 设备选择器使用了`getAvailableDevices`API，但这个API可能没有正确实现或返回空数据。

**修复方案**:
- 修改`DeviceSelector.vue`组件，使用正确的设备管理API
- 将API调用从`getAvailableDevices`改为`getDeviceList`
- 添加数据格式转换，确保前端组件能正确显示设备数据

### 2. 修复搜索表单字段

**问题**: 搜索表单的字段名称与API参数不匹配。

**修复方案**:
- 将搜索字段从"产品名称"改为"产品ID"
- 更新搜索参数映射，使用`eqName`和`productsId`
- 添加数字类型验证

### 3. 数据格式转换

**问题**: 设备管理API返回的数据格式与设备选择器期望的格式不匹配。

**修复方案**:
```javascript
// 转换数据格式
availableDevices.value = (response.data.list || []).map(device => ({
  id: device.ID,
  deviceName: device.eqName,
  productName: device.productsId ? `产品ID: ${device.productsId}` : '-',
  status: device.status || '启用'
}))
```

## 修复的文件

### 前端文件
1. `gin-vue-admin-main/web/src/view/system/department/components/DeviceSelector.vue`
   - 修复API调用
   - 更新搜索表单字段
   - 添加数据格式转换
   - 修复导入语句

### 测试文件
1. `gin-vue-admin-main/test_device_selector.js`
   - 创建设备选择器测试脚本

### 数据库脚本
1. `gin-vue-admin-main/check_device_data.sql`
   - 检查设备数据的SQL脚本

## 使用说明

### 1. 检查设备数据
执行以下SQL脚本检查数据库中是否有设备数据：
```sql
-- 检查设备数据
SELECT COUNT(*) as device_count FROM wl_equipment;

-- 如果没有数据，插入测试设备
INSERT INTO wl_equipment (eq_name, products_id, eq_info, status, created_at, updated_at) VALUES
('测试设备001', 1, '这是一个测试设备', '启用', NOW(), NOW()),
('测试设备002', 2, '这是另一个测试设备', '启用', NOW(), NOW()),
('测试设备003', 3, '第三个测试设备', '启用', NOW(), NOW());
```

### 2. 测试设备选择器
在浏览器控制台中运行测试脚本：
```javascript
// 复制 test_device_selector.js 中的函数到控制台
testGetDeviceList();
```

### 3. 验证功能
1. 进入部门管理页面
2. 点击"新增"按钮
3. 点击"选择设备"按钮
4. 验证设备列表是否正确显示
5. 测试搜索功能（按设备名称或产品ID搜索）
6. 测试设备选择和确认功能

## 功能验证

修复后的设备选择器应该支持：
1. ✅ 正确显示设备列表
2. ✅ 按设备名称搜索
3. ✅ 按产品ID搜索
4. ✅ 设备选择和移除
5. ✅ 分页显示
6. ✅ 确认选择并返回给部门管理

## 注意事项

1. 确保数据库中有设备数据
2. 确保后端服务正常运行
3. 确保前端服务正常运行
4. 如果设备列表仍为空，请检查：
   - 数据库连接是否正常
   - 设备API是否正常返回数据
   - 浏览器控制台是否有错误信息

## 故障排除

### 如果设备列表仍为空：

1. **检查数据库**:
   ```sql
   SELECT * FROM wl_equipment LIMIT 5;
   ```

2. **检查API响应**:
   在浏览器控制台运行：
   ```javascript
   testGetDeviceList();
   ```

3. **检查网络请求**:
   - 打开浏览器开发者工具
   - 查看Network标签页
   - 检查`/api/wlEquipment/getWlEquipmentList`请求的响应

4. **检查后端日志**:
   - 查看后端服务日志
   - 检查是否有错误信息

### 如果搜索功能不工作：

1. 检查搜索参数是否正确传递
2. 检查后端搜索逻辑是否正确
3. 检查前端搜索表单字段名称是否与API参数匹配 